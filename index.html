<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBRO - Redirecting to App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .manual-link {
            margin-top: 20px;
            display: none;
        }
        .manual-link a {
            color: #ffd700;
            text-decoration: none;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NBRO Field Surveyor</h1>
        <div class="spinner" id="spinner"></div>
        <p id="status">Validating invitation...</p>

        <div id="inviteForm" style="display:none; margin-top: 16px; text-align: left;">
            <p style="margin: 0 0 10px 0;"><strong>Email</strong></p>
            <p id="emailText" style="margin: 0 0 16px 0; word-break: break-all;"></p>

            <label for="passwordInput" style="display:block; margin-bottom: 8px;">Set your password</label>
            <input id="passwordInput" type="password" minlength="6" placeholder="At least 6 characters"
                style="width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: none; margin-bottom: 12px;" />

            <label for="confirmPasswordInput" style="display:block; margin-bottom: 8px;">Confirm password</label>
            <input id="confirmPasswordInput" type="password" minlength="6" placeholder="Re-enter password"
                style="width: 100%; box-sizing: border-box; padding: 10px; border-radius: 8px; border: none; margin-bottom: 16px;" />

            <button id="setPasswordBtn"
                style="width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                Set Password and Open App
            </button>
        </div>

        <div class="manual-link" id="manualLink">
            <p>If the app doesn't open automatically:</p>
            <a href="#" id="deepLink">Click here to open the app</a>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bazelkzuwxcrmapbuzyp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhemVsa3p1d3hjcm1hcGJ1enlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4MjY0NTYsImV4cCI6MjA4NDQwMjQ1Nn0.bCuiTsDIXKKQaqPRVBcTfrp44APXtCAp8QpovVaBywk';

        let authHash = '';
        let accessToken = '';
        let refreshToken = '';

        function decodeJwtPayload(token) {
            try {
                const base64 = token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch {
                return null;
            }
        }

        function openApp() {
            const deepLink = `nbroapp://auth-callback#${authHash}`;
            document.getElementById('deepLink').href = deepLink;
            window.location.href = deepLink;
            document.getElementById('manualLink').style.display = 'block';
        }

        async function setPasswordAndOpenApp() {
            const statusEl = document.getElementById('status');
            const buttonEl = document.getElementById('setPasswordBtn');
            const password = document.getElementById('passwordInput').value;
            const confirmPassword = document.getElementById('confirmPasswordInput').value;

            if (!password || password.length < 6) {
                statusEl.textContent = 'Password must be at least 6 characters.';
                return;
            }

            if (password !== confirmPassword) {
                statusEl.textContent = 'Passwords do not match.';
                return;
            }

            buttonEl.disabled = true;
            statusEl.textContent = 'Saving password...';

            try {
                const response = await fetch(`${SUPABASE_URL}/auth/v1/user`, {
                    method: 'PUT',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        password: password,
                        data: {
                            invite_completed: true
                        }
                    })
                });

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err || 'Failed to set password');
                }

                statusEl.textContent = 'Password saved. Opening app...';
                setTimeout(openApp, 600);
            } catch (error) {
                statusEl.textContent = 'Could not set password. Please try again.';
                buttonEl.disabled = false;
                console.error('Set password error:', error);
            }
        }

        function setupInvitePage() {
            try {
                const hash = window.location.hash.substring(1);
                authHash = hash;
                
                if (hash) {
                    const params = new URLSearchParams(hash);
                    accessToken = params.get('access_token') || '';
                    refreshToken = params.get('refresh_token') || '';
                    const type = params.get('type') || '';
                    
                    if (!accessToken || !refreshToken) {
                        throw new Error('Missing auth tokens in callback URL');
                    }

                    const payload = decodeJwtPayload(accessToken);
                    const email = payload?.email || 'Invited officer';

                    if (type && type !== 'invite' && type !== 'recovery') {
                        console.warn('Unexpected auth type:', type);
                    }
                    
                    document.getElementById('spinner').style.display = 'none';
                    document.getElementById('status').textContent = 'Invitation verified. Set your password to continue.';
                    document.getElementById('emailText').textContent = email;
                    document.getElementById('inviteForm').style.display = 'block';
                    document.getElementById('setPasswordBtn').addEventListener('click', setPasswordAndOpenApp);
                } else {
                    document.getElementById('status').textContent = 
                        'No authentication data received. Please try again.';
                    console.error('No hash fragment found in URL');
                }
            } catch (error) {
                console.error('Redirect error:', error);
                document.getElementById('status').textContent = 
                    'An error occurred. Please request a new invitation link.';
                document.getElementById('manualLink').style.display = 'block';
            }
        }
        
        window.addEventListener('load', setupInvitePage);
    </script>
</body>
</html>
